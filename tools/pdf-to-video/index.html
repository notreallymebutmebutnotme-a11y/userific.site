<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PDF + Audio → MP4 Tool</title>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js"></script>

  <!-- FFmpeg.wasm -->
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.5/dist/ffmpeg.min.js"></script>

  <style>
    body { font-family: sans-serif; background: #f4f4f4; color: #111; padding: 20px; }
    input, select, button { margin: 6px 0; padding: 6px; }
    #status { margin-top: 10px; font-weight: bold; }
    #download { margin-top: 15px; }
  </style>
</head>
<body>
  <h2>PDF + Audio → MP4 Tool</h2>

  <div>⚠️ Do not close or refresh this tab while processing.</div><br>

  <label>Upload PDF:</label><br>
  <input type="file" id="pdfInput" accept="application/pdf"><br>

  <label>Upload Audio (MP3/WAV):</label><br>
  <input type="file" id="audioInput" accept=".mp3,.wav"><br>

  <label>Resolution:</label><br>
  <select id="resolution">
    <option value="1920x1080">1080p (1920×1080)</option>
    <option value="2560x1440">1440p (2560×1440)</option>
    <option value="3840x2160">4K (3840×2160)</option>
  </select><br><br>

  <button id="processBtn">Generate Video</button>

  <div id="status"></div>
  <div id="download"></div>

<script>
const { createFFmpeg, fetchFile } = FFmpeg;
const ffmpeg = createFFmpeg({ log: true });

async function renderPDFtoImages(file, resolution) {
  const pdfData = new Uint8Array(await file.arrayBuffer());
  const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;

  const [width, height] = resolution.split("x").map(Number);
  const images = [];

  for (let p = 1; p <= pdf.numPages; p++) {
    const page = await pdf.getPage(p);
    const viewport = page.getViewport({ scale: 2.0 });
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    canvas.width = viewport.width;
    canvas.height = viewport.height;

    await page.render({ canvasContext: ctx, viewport }).promise;

    // Scale to target resolution & fit top
    const finalCanvas = document.createElement("canvas");
    finalCanvas.width = width;
    finalCanvas.height = height;
    const fctx = finalCanvas.getContext("2d");
    fctx.fillStyle = "#000";
    fctx.fillRect(0, 0, width, height);

    const scale = width / canvas.width;
    const scaledHeight = canvas.height * scale;
    fctx.drawImage(canvas, 0, 0, width, scaledHeight);

    const blob = await new Promise(res => finalCanvas.toBlob(res, "image/png"));
    images.push(new File([blob], `page${p}.png`));
  }
  return images;
}

document.getElementById("processBtn").addEventListener("click", async () => {
  const pdfFile = document.getElementById("pdfInput").files[0];
  const audioFile = document.getElementById("audioInput").files[0];
  const resolution = document.getElementById("resolution").value;

  if (!pdfFile || !audioFile) {
    alert("Please select PDF and Audio files.");
    return;
  }

  document.getElementById("status").innerText = "Rendering PDF pages...";
  const images = await renderPDFtoImages(pdfFile, resolution);

  if (!ffmpeg.isLoaded()) {
    document.getElementById("status").innerText = "Loading FFmpeg...";
    await ffmpeg.load();
  }

  // Write files into FFmpeg FS
  for (let img of images) {
    ffmpeg.FS("writeFile", img.name, await fetchFile(img));
  }
  ffmpeg.FS("writeFile", "audio.mp3", await fetchFile(audioFile));

  document.getElementById("status").innerText = "Encoding video... (this may take a while)";

  const [w, h] = resolution.split("x");

  // Build input list for FFmpeg concat
  let inputTxt = "";
  for (let i = 0; i < images.length; i++) {
    inputTxt += `file '${images[i].name}'\n`;
    inputTxt += "duration 3\n"; // default 3s per slide
  }
  inputTxt += `file '${images[images.length - 1].name}'\n`;

  ffmpeg.FS("writeFile", "input.txt", inputTxt);

  // FFmpeg command: images -> video -> overlay audio
  await ffmpeg.run(
    "-f", "concat", "-safe", "0", "-i", "input.txt",
    "-i", "audio.mp3",
    "-vf", `fade=t=in:st=0:d=0.5,fade=t=out:st=2.5:d=0.5,scale=${w}:${h},fps=30,format=yuv420p`,
    "-c:v", "libx264", "-pix_fmt", "yuv420p",
    "-c:a", "aac", "-shortest",
    "output.mp4"
  );

  const data = ffmpeg.FS("readFile", "output.mp4");
  const url = URL.createObjectURL(new Blob([data.buffer], { type: "video/mp4" }));

  document.getElementById("status").innerText = "Done!";
  document.getElementById("download").innerHTML = `<a href="${url}" download="output.mp4">⬇️ Download MP4</a>`;
});
</script>
</body>
</html>
