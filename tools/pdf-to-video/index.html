<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PDF + Audio → Video Tool</title>
</head>
<body>
  <h2>PDF + Audio to Video</h2>
  <input type="file" id="pdfFile" accept="application/pdf" />
  <input type="file" id="audioFile" accept="audio/*" />
  <select id="resolution">
    <option value="1080">1080p</option>
    <option value="1440">1440p</option>
    <option value="2160">4K</option>
  </select>
  <button id="processBtn">Process</button>
  <button id="exportBtn">Export Video</button>
  <div id="progress">Idle</div>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <!-- Tesseract.js for OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.3/dist/tesseract.min.js"></script>
  <!-- ffmpeg.wasm via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js"></script>

  <script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({
      log: true,
      corePath: "https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/ffmpeg-core.js"
    });

    const progressEl = document.getElementById("progress");
    const pdfInput = document.getElementById("pdfFile");
    const audioInput = document.getElementById("audioFile");
    const resInput = document.getElementById("resolution");

    let audioFile, pdfFile, audioWav, pdfPages = [];

    function setProgress(msg) {
      progressEl.textContent = msg;
      console.log(msg);
    }

    async function loadFFmpeg() {
      if (!ffmpeg.isLoaded()) {
        setProgress("Loading ffmpeg.wasm core from CDN...");
        await ffmpeg.load();
        setProgress("ffmpeg.wasm ready ✅");
      }
    }

    async function processFiles() {
      await loadFFmpeg();

      // convert audio to wav
      audioFile = audioInput.files[0];
      pdfFile = pdfInput.files[0];
      if (!audioFile || !pdfFile) {
        setProgress("Please upload both PDF and audio!");
        return;
      }

      setProgress("Converting audio...");
      ffmpeg.FS("writeFile", "input", await fetchFile(audioFile));
      await ffmpeg.run("-i", "input", "-ar", "44100", "-ac", "2", "audio.wav");
      audioWav = ffmpeg.FS("readFile", "audio.wav");
      setProgress("Audio converted ✅");

      // render PDF to canvases
      const pdfData = await pdfFile.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
      pdfPages = [];

      for (let i = 1; i <= pdf.numPages; i++) {
        setProgress(`Rendering page ${i}/${pdf.numPages}...`);
        const page = await pdf.getPage(i);
        const viewport = page.getViewport({ scale: 2 });
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        await page.render({ canvasContext: ctx, viewport }).promise;

        // OCR if page has no text
        const textContent = await page.getTextContent();
        if (textContent.items.length === 0) {
          setProgress(`Running OCR on page ${i}...`);
          await Tesseract.recognize(canvas, "eng");
        }

        pdfPages.push(canvas.toDataURL("image/png"));
      }

      setProgress("PDF rendered ✅ Ready to export.");
    }

    async function exportVideo() {
      if (!pdfPages.length || !audioWav) {
        setProgress("Please process files first!");
        return;
      }
      await loadFFmpeg();

      const res = parseInt(resInput.value);
      const height = res;
      const width = Math.floor((16 / 9) * height);
      const pageDuration = 5; // seconds per page for demo
      const fps = 30;

      setProgress("Creating frames...");
      pdfPages.forEach((imgData, i) => {
        const img = atob(imgData.split(",")[1]);
        const buf = new Uint8Array(img.length);
        for (let j = 0; j < img.length; j++) buf[j] = img.charCodeAt(j);
        ffmpeg.FS("writeFile", `page${i}.png`, buf);
      });

      setProgress("Encoding video...");
      await ffmpeg.run(
        "-framerate", String(fps),
        "-i", "page%d.png",
        "-i", "audio.wav",
        "-c:v", "libx264",
        "-pix_fmt", "yuv420p",
        "-s", `${width}x${height}`,
        "out.mp4"
      );

      const data = ffmpeg.FS("readFile", "out.mp4");
      const url = URL.createObjectURL(new Blob([data.buffer], { type: "video/mp4" }));
      const a = document.createElement("a");
      a.href = url;
      a.download = "output.mp4";
      a.click();
      setProgress("Export complete ✅");
    }

    document.getElementById("processBtn").onclick = processFiles;
    document.getElementById("exportBtn").onclick = exportVideo;
  </script>
</body>
</html>
